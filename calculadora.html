<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Orçamento | Aço Fino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { gold: { 400: '#D4AF37', 500: '#C5A028' }, zinc: { 850: '#1f1f22', 950: '#0c0c0c' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Playfair Display', 'serif'] }
                }
            }
        }
    </script>
    <style>
        input, select, textarea { font-size: 16px !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f1f22; }
        ::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 4px; }
        body { overflow-x: hidden; width: 100%; position: relative; background-color: #0c0c0c; }
    </style>
</head>
<body class="text-gray-300 font-sans antialiased min-h-screen selection:bg-gold-400 selection:text-black">

    <div id="loading-overlay" class="fixed inset-0 bg-zinc-950 z-[999] hidden flex-col justify-center items-center">
        <i class="ph ph-spinner animate-spin text-5xl mb-4 text-gold-400"></i>
        <p class="text-sm tracking-widest uppercase font-bold text-white">Gerando PDF...</p>
        <p class="text-xs text-gray-500 mt-2 text-center px-6">Preparando o arquivo para envio. Aguarde.</p>
    </div>

    <div id="app-calculadora" class="max-w-3xl w-full mx-auto bg-zinc-900 border-x border-white/5 flex flex-col shadow-2xl relative pb-36 min-h-screen">
        
        <div class="bg-black/80 backdrop-blur-md p-5 border-b border-white/10 flex items-center justify-between sticky top-0 z-40">
            <div>
                <h1 class="text-xl md:text-2xl font-serif text-white">Calculadora <span class="text-gold-400 italic">Fina</span></h1>
                <p class="text-[10px] md:text-xs text-gray-500 uppercase tracking-widest mt-1">Orçamento Rápido</p>
            </div>
            <i class="ph ph-calculator text-3xl text-gold-400"></i>
        </div>

        <div class="p-4 md:p-8 flex-1 flex flex-col gap-6">
            
            <div class="bg-zinc-950 p-4 border border-white/5 rounded-md">
                <h2 class="text-xs font-bold text-gold-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="ph ph-magnifying-glass"></i> 1. Material Cadastrado
                </h2>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="block text-xs text-gray-400 mb-1">Busque o ferro ou acessório padrão:</label>
                        <div class="relative">
                            <input type="text" id="input-busca" placeholder="Ex: Tubo 20x20..." onkeyup="filtrarMateriais()" autocomplete="off" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 pl-10 focus:outline-none focus:border-gold-400 transition-colors text-sm">
                            <i class="ph ph-magnifying-glass absolute left-3 top-3.5 text-gray-400 text-lg"></i>
                        </div>
                        <ul id="dropdown-materiais" class="absolute z-50 w-full bg-zinc-800 border border-zinc-700 mt-1 max-h-60 overflow-y-auto rounded-md shadow-2xl hidden">
                        </ul>
                    </div>
                    <div class="flex gap-2 items-end">
                        <div class="w-[60%]">
                            <label class="block text-xs text-gray-400 mb-1" id="label-quantidade">Metros / Qtd.</label>
                            <input type="number" id="input-metros" step="0.1" placeholder="Ex: 2.5" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 focus:outline-none focus:border-gold-400 transition-colors text-sm text-center">
                        </div>
                        <div class="w-[40%]">
                            <button onclick="adicionarMaterial()" class="w-full h-[46px] bg-zinc-800 border border-gold-400/30 hover:bg-gold-400 hover:text-black text-gold-400 text-xs font-bold uppercase tracking-wider rounded-md transition-colors flex justify-center items-center gap-1">
                                <i class="ph ph-plus-circle text-lg"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-zinc-950 p-4 border border-white/5 rounded-md -mt-2">
                <h2 class="text-xs font-bold text-gold-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="ph ph-package"></i> 2. Insumos Extras Livres
                </h2>
                <div class="grid grid-cols-12 gap-2 items-end">
                    <div class="col-span-6">
                        <label class="block text-xs text-gray-400 mb-1">O que é?</label>
                        <input type="text" id="input-extra-nome" placeholder="Ex: Madeira" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 focus:outline-none focus:border-gold-400 text-sm">
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs text-gray-400 mb-1">R$ Total</label>
                        <input type="number" id="input-extra-valor" placeholder="0.00" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 focus:outline-none focus:border-gold-400 text-sm text-center">
                    </div>
                    <div class="col-span-3">
                        <button onclick="adicionarExtra()" class="w-full h-[46px] bg-zinc-800 border border-gold-400/30 hover:bg-gold-400 hover:text-black text-gold-400 text-xs font-bold uppercase rounded-md transition-colors flex justify-center items-center">
                            Add
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xs font-bold text-white uppercase tracking-wider mb-2 border-b border-white/10 pb-2">Lista da Peça</h2>
                <div id="lista-materiais" class="space-y-2 min-h-[80px]">
                    <p class="text-xs text-gray-600 italic py-2">Nenhum item adicionado ainda.</p>
                </div>
            </div>

            <div class="bg-zinc-950 p-4 border border-white/5 rounded-md mt-2">
                <h2 class="text-xs font-bold text-gold-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="ph ph-paint-roller"></i> 3. Pintura / Acabamento
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1 uppercase tracking-wider">Metros Pintura</label>
                        <input type="number" id="qtd-pintura" value="0" step="0.1" oninput="calcularTotal()" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 text-center focus:outline-none focus:border-gold-400">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1 uppercase tracking-wider">M² Pintura (R$)</label>
                        <input type="number" id="valor-pintura" value="8.00" oninput="calcularTotal()" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 text-center focus:outline-none focus:border-gold-400">
                    </div>
                </div>
            </div>

            <div class="bg-zinc-950 p-4 border border-white/5 rounded-md mt-2">
                <h2 class="text-xs font-bold text-gold-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <i class="ph ph-chart-line-up"></i> 4. Complexidade (Multiplicador)
                </h2>
                <div class="flex items-center gap-4">
                    <div class="w-1/3">
                        <input type="number" id="multiplicador" value="2.5" step="0.1" oninput="calcularTotal()" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 focus:outline-none focus:border-gold-400 font-bold text-lg text-center">
                    </div>
                    <div class="w-2/3">
                        <p class="text-[10px] text-gray-500 leading-tight">Define sua margem de lucro e mão de obra com base na dificuldade da peça (Ex: 2.5x, 3x, 4x).</p>
                    </div>
                </div>
            </div>

            <div class="bg-zinc-950 p-4 border border-white/5 rounded-md mt-2">
                <h2 class="text-xs font-bold text-gold-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <i class="ph ph-shield-check"></i> 5. Margem Extra (%)
                </h2>
                <div class="flex items-center gap-4">
                    <div class="w-1/3">
                        <input type="number" id="margem-lucro" value="15" oninput="calcularTotal()" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-md p-3 focus:outline-none focus:border-gold-400 font-bold text-lg text-center">
                    </div>
                    <div class="w-2/3">
                        <p class="text-[10px] text-gray-500 leading-tight">Cobre custos que não dão para prever (disco extra, gás da solda, lixas, frete).</p>
                    </div>
                </div>
            </div>

            <div class="bg-zinc-900 border border-zinc-700 rounded-md p-4 mt-2 mb-4">
                <h2 class="text-xs font-bold text-white uppercase tracking-wider mb-3 flex items-center gap-2 border-b border-zinc-700 pb-2">
                    <i class="ph ph-receipt text-gold-400"></i> 6. Detalhamento dos Custos
                </h2>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li class="flex justify-between">
                        <span>Materiais e Insumos:</span>
                        <span id="detalhe-materiais" class="text-white font-mono">R$ 0,00</span>
                    </li>
                    <li class="flex justify-between border-b border-zinc-700 pb-2">
                        <span>Pintura Terceirizada:</span>
                        <span id="detalhe-pintura" class="text-white font-mono">R$ 0,00</span>
                    </li>
                    <li class="flex justify-between pt-1">
                        <span>Custo Bruto (O que você gasta):</span>
                        <span id="detalhe-custo-bruto" class="text-gray-300 font-mono font-bold">R$ 0,00</span>
                    </li>
                    <li class="flex justify-between pt-2">
                        <span>Margem Imprevistos (<span id="txt-porcentagem-margem">15</span>%):</span>
                        <span id="detalhe-margem" class="text-gray-300 font-mono">R$ 0,00</span>
                    </li>
                    <li class="flex justify-between pt-2">
                        <span class="text-gold-400/80">Sua Mão de Obra e Lucro:</span>
                        <span id="detalhe-lucro" class="text-gold-400 font-mono">R$ 0,00</span>
                    </li>
                    <li class="flex justify-between font-bold text-white pt-3 border-t border-zinc-700 mt-2 text-lg">
                        <span>Total Sugerido:</span>
                        <span id="detalhe-total" class="text-gold-400 font-mono">R$ 0,00</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="bg-zinc-950 border-t border-gold-400/30 p-4 fixed bottom-0 w-full z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
        <div class="max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-3">
                <div class="text-xs text-gray-400">
                    Custo Bruto: <span id="resumo-custo" class="text-white ml-1 font-mono">R$ 0,00</span>
                </div>
                <div class="text-right">
                    <span class="block text-[10px] uppercase tracking-widest text-gold-400">Valor pro Cliente</span>
                    <span id="preco-final" class="text-2xl font-serif text-white font-bold leading-none">R$ 0,00</span>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-2 border-t border-white/10 pt-3">
                <div class="col-span-3">
                    <button onclick="limparTudo()" class="w-full h-[40px] bg-red-900/20 text-red-400 rounded-md hover:bg-red-900/50 transition-colors flex justify-center items-center">
                        <i class="ph ph-trash text-lg"></i>
                    </button>
                </div>
                <div class="col-span-9">
                    <button id="btn-compartilhar" onclick="compartilharPDF()" class="w-full h-[40px] bg-gold-400 hover:bg-gold-500 text-black font-bold uppercase tracking-wider text-[11px] md:text-xs rounded-md transition-colors flex justify-center items-center gap-2 shadow-lg shadow-gold-400/20">
                        <i class="ph ph-share-network text-lg"></i> Compartilhar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-section" class="hidden bg-white text-black p-10 w-[794px] min-h-[1122px] mx-auto absolute top-0 left-0 z-0">
        
        <div class="border-b-2 border-black pb-4 mb-8 flex justify-between items-end">
            <div>
                <img src="img/logo-orc.png" crossorigin="anonymous" alt="Aço Fino" class="h-16 w-auto object-contain mb-2">
            </div>
            <div class="text-right">
                <h2 class="text-2xl font-bold tracking-widest uppercase">Orçamento</h2>
                <p class="text-base text-gray-600 mt-1" id="print-data">Data: 00/00/0000</p>
            </div>
        </div>

        <p class="text-lg mb-8 text-gray-800">Abaixo estão os detalhes do projeto sob medida solicitado, contemplando materiais, estrutura e acabamentos.</p>

        <div class="mb-10">
            <h3 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-2 mb-4 text-black">Estrutura e Materiais Utilizados</h3>
            <ul id="print-lista-materiais" class="list-disc pl-6 space-y-3 text-base text-gray-800">
                </ul>
        </div>

        <div class="mb-10">
            <h3 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-2 mb-4 text-black">Serviços e Acabamentos Inclusos</h3>
            <ul id="print-lista-servicos" class="list-disc pl-6 space-y-3 text-base text-gray-800">
                <li>Corte, esquadrejamento e montagem estrutural sob medida.</li>
                <li>Soldagem premium e polimento de junções para acabamento impecável.</li>
                </ul>
        </div>

        <div class="mt-10 pt-8 border-t-2 border-black flex justify-between items-center bg-gray-50 px-6 py-6 rounded-lg">
            <div class="text-sm text-gray-600 space-y-2 w-2/3">
                <p>• Orçamento válido por 7 dias corridos.</p>
                <p>• O prazo de produção inicia após a confirmação do projeto.</p>
                <p>• Produto entregue pronto. Não inclui instalação no local.</p>
            </div>
            <div class="text-right w-1/3">
                <p class="text-sm uppercase tracking-widest mb-2 text-gray-500 font-bold">Investimento Total</p>
                <p class="text-4xl font-serif font-bold text-black" id="print-total">R$ 0,00</p>
            </div>
        </div>
    </div>

    <script>
        const dbMateriais = [
            { nome: "Tubo Quadrado Galv. 15 X 15 1.25MM(18)", preco: 35.99 },
            { nome: "Tubo Quadrado Galv. 20 X 20 0.95MM(20)", preco: 40.99 },
            { nome: "Tubo Quadrado Galv. 20 X 20 1.25MM(18)", preco: 50.20 },
            { nome: "Tubo Quadrado Galv. 20 X 20 1.55MM(16)", preco: 59.26 },
            { nome: "Tubo Quadrado Galv. 25 X 25 0.95MM(20)", preco: 55.00 },
            { nome: "Tubo Quadrado Galv. 25 X 25 1.25MM(18)", preco: 63.20 },
            { nome: "Tubo Quadrado Galv. 25 X 25 1.55MM(16)", preco: 77.25 },
            { nome: "Tubo Quadrado Galv. 30 X 30 0.95MM(20)", preco: 62.60 },
            { nome: "Tubo Quadrado Galv. 30 X 30 1.25MM(18)", preco: 77.68 },
            { nome: "Tubo Quadrado Galv. 30 X 30 1.55MM(16)", preco: 91.99 },
            { nome: "Tubo Quadrado Galv. 40 X 40 1.25MM(18)", preco: 104.90 },
            { nome: "Tubo Quadrado Galv. 40 X 40 1.55MM(16)", preco: 128.00 },
            { nome: "Tubo Quadrado Galv. 50 X 50 1.25MM(18)", preco: 129.99 },
            { nome: "Tubo Quadrado Galv. 50 X 50 1.55MM(16)", preco: 158.30 },

            { nome: "Tubo Retangular Galv. 20 X 30 0.95MM(20)", preco: 50.40 },
            { nome: "Tubo Retangular Galv. 20 X 30 1.25MM(18)", preco: 62.99 },
            { nome: "Tubo Retangular Galv. 20 X 30 1.55MM(16)", preco: 76.91 },
            { nome: "Tubo Retangular Galv. 20 X 40 0.95MM(20)", preco: 63.29 },
            { nome: "Tubo Retangular Galv. 20 X 40 1.25MM(18)", preco: 76.30 },
            { nome: "Tubo Retangular Galv. 20 X 40 1.55MM(16)", preco: 93.30 },
            { nome: "Tubo Retangular Galv. 20 X 50 1.25MM(18)", preco: 95.30 },
            { nome: "Tubo Retangular Galv. 20 X 50 1.55MM(16)", preco: 104.50 },
            { nome: "Tubo Retangular Galv. 30 X 40 0.95MM(20)", preco: 70.55 },
            { nome: "Tubo Retangular Galv. 30 X 40 1.25MM(18)", preco: 90.90 },
            { nome: "Tubo Retangular Galv. 30 X 40 1.55MM(16)", preco: 108.99 },
            { nome: "Tubo Retangular Galv. 30 X 50 0.95MM(20)", preco: 86.60 },
            { nome: "Tubo Retangular Galv. 30 X 50 1.25MM(18)", preco: 96.30 },
            { nome: "Tubo Retangular Galv. 30 X 50 1.55MM(16)", preco: 125.99 },

            { nome: "Tubo Redondo Ind. Galv. 5/8 X 0.95MM(20)", preco: 25.60 },
            { nome: "Tubo Redondo Ind. Galv. 5/8 X 1.25MM(18)", preco: 35.99 },
            { nome: "Tubo Redondo Ind. Galv. 3/4 X 1.25MM(18)", preco: 37.20 },
            { nome: "Tubo Redondo Ind. Galv. 3/4 X 1.55MM(16)", preco: 45.99 },
            { nome: "Tubo Redondo Ind. Galv. 7/8 X 1.25MM(18)", preco: 44.30 },
            { nome: "Tubo Redondo Ind. Galv. 7/8 X 1.55MM(16)", preco: 49.50 },
            { nome: "Tubo Redondo Ind. Galv. 1POL X 1.25MM(18)", preco: 49.95 },
            { nome: "Tubo Redondo Ind. Galv. 1POL X 1.55MM(16)", preco: 62.49 },
            { nome: "Tubo Redondo Ind. Galv. 1.1/4 X 1.25MM(18)", preco: 65.99 },
            { nome: "Tubo Redondo Ind. Galv. 1.1/4 X 1.55MM(16)", preco: 78.30 },
            { nome: "Tubo Redondo Ind. Galv. 1.1/2 X 1.25MM(18)", preco: 74.99 },
            { nome: "Tubo Redondo Ind. Galv. 1.1/2 X 1.55MM(16)", preco: 96.30 },
            { nome: "Tubo Redondo Ind. Galv. 2POL X 1.25MM(18)", preco: 99.99 },
            { nome: "Tubo Redondo Ind. Galv. 2POL X 1.55MM(16)", preco: 123.99 },

            { nome: "Ferro Redondo Zincado 1/4", preco: 18.90 },
            { nome: "Ferro Redondo Zincado 5/16", preco: 27.90 },
            { nome: "Ferro Redondo Zincado 3/8", preco: 41.90 },
            { nome: "Ferro Redondo Zincado 1/2", preco: 69.89 },
            { nome: "Ferro Quadrado Zincado 5/16", preco: 40.65 },
            { nome: "Ferro Quadrado Zincado 1/2", preco: 100.95 },

            { nome: "Ferro Chato Zincado 3/8 X 1/8", preco: 17.35 },
            { nome: "Ferro Chato Zincado 1/2 X 1/8", preco: 25.09 },
            { nome: "Ferro Chato Zincado 1/2 X 3/16", preco: 33.98 },
            { nome: "Ferro Chato Zincado 5/8 X 1/8", preco: 28.92 },
            { nome: "Ferro Chato Zincado 5/8 X 3/16", preco: 42.70 },
            { nome: "Ferro Chato Zincado 3/4 X 1/8", preco: 34.70 },
            { nome: "Ferro Chato Zincado 3/4 X 3/16", preco: 51.39 },
            { nome: "Ferro Chato Zincado 7/8 X 1/8", preco: 39.80 },
            { nome: "Ferro Chato Zincado 7/8 X 3/16", preco: 60.00 },
            { nome: "Ferro Chato Zincado 1 X 1/8", preco: 45.99 },
            { nome: "Ferro Chato Zincado 1 X 3/16", preco: 68.68 },
            { nome: "Ferro Chato Zincado 1 X 1/4", preco: 90.86 },
            { nome: "Ferro Chato Zincado 1.1/4 X 1/8", preco: 57.99 },
            { nome: "Ferro Chato Zincado 1.1/4 X 3/16", preco: 86.60 },
            { nome: "Ferro Chato Zincado 1.1/4 X 1/4", preco: 114.90 },
            { nome: "Ferro Chato Zincado 1.1/2 X 1/8", preco: 77.85 },
            { nome: "Ferro Chato Zincado 1.1/2 X 3/16", preco: 102.91 },
            { nome: "Ferro Chato Zincado 1.1/2 X 1/4", preco: 137.37 },
            { nome: "Ferro Chato Zincado 2 X 1/8", preco: 91.82 },
            { nome: "Ferro Chato Zincado 2 X 3/16", preco: 137.37 },
            { nome: "Ferro Chato Zincado 2 X 1/4", preco: 182.99 },

            { nome: "Cantoneira Zincada 1/2 X 1/8", preco: 39.99 },
            { nome: "Cantoneira Zincada 3/4 X 1/8", preco: 63.90 },
            { nome: "Cantoneira Zincada 7/8 X 1/8", preco: 75.99 },
            { nome: "Cantoneira Zincada 1 X 1/8", preco: 86.50 },
            { nome: "Cantoneira Zincada 1 X 3/16", preco: 125.75 },
            { nome: "Cantoneira Zincada 1.1/4 X 1/8", preco: 109.20 },
            { nome: "Cantoneira Zincada 1.1/4 X 3/16", preco: 159.99 },
            { nome: "Cantoneira Zincada 1.1/4 X 1/4", preco: 208.20 },
            { nome: "Cantoneira Zincada 1.1/2 X 3/16", preco: 195.10 },
            { nome: "Cantoneira Zincada 1.1/2 X 1/4", preco: 252.95 },
            { nome: "Cantoneira Zincada 2 X 3/16", preco: 263.75 },
            { nome: "Cantoneira Zincada 2 X 1/4", preco: 345.90 },

            { nome: "Sapata Regulável", preco: 2.50, porUnidade: true },
            { nome: "Orelhinha (Fixação)", preco: 0.50, porUnidade: true },
            { nome: "Tampa de Tubo (Ponteira)", preco: 1.50, porUnidade: true }
        ];

        let materiaisAdicionados = [];
        let materialSelecionado = null; 

        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function filtrarMateriais() {
            const termo = document.getElementById('input-busca').value.toLowerCase();
            const dropdown = document.getElementById('dropdown-materiais');
            dropdown.innerHTML = '';
            materialSelecionado = null; 

            if (termo.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            const resultados = dbMateriais.filter(mat => mat.nome.toLowerCase().includes(termo));

            if (resultados.length > 0) {
                dropdown.classList.remove('hidden');
                resultados.forEach((mat) => {
                    const li = document.createElement('li');
                    li.className = "p-3 hover:bg-zinc-700 cursor-pointer text-sm border-b border-zinc-700 flex justify-between items-center";
                    const infoPreco = mat.porUnidade ? `R$ ${mat.preco.toFixed(2)} / un` : `R$ ${mat.preco.toFixed(2)} / 6m`;
                    li.innerHTML = `<span class="flex-1">${mat.nome}</span> <span class="text-gold-400 text-xs ml-2 whitespace-nowrap">${infoPreco}</span>`;
                    
                    li.onclick = () => { selecionarMaterial(mat); };
                    dropdown.appendChild(li);
                });
            } else {
                dropdown.classList.remove('hidden');
                dropdown.innerHTML = '<li class="p-3 text-sm text-gray-500">Nenhum material encontrado.</li>';
            }
        }

        function selecionarMaterial(mat) {
            materialSelecionado = mat;
            document.getElementById('input-busca').value = mat.nome;
            document.getElementById('dropdown-materiais').classList.add('hidden');
            
            if (mat.porUnidade) {
                document.getElementById('label-quantidade').innerText = 'Quantidade (Unid.)';
                document.getElementById('input-metros').placeholder = 'Ex: 4';
            } else {
                document.getElementById('label-quantidade').innerText = 'Metros Usados';
                document.getElementById('input-metros').placeholder = 'Ex: 2.5';
            }
            document.getElementById('input-metros').focus(); 
        }

        document.addEventListener('click', function(event) {
            const isClickInside = document.getElementById('input-busca').contains(event.target) || document.getElementById('dropdown-materiais').contains(event.target);
            if (!isClickInside) {
                document.getElementById('dropdown-materiais').classList.add('hidden');
            }
        });

        function adicionarMaterial() {
            if (!materialSelecionado) {
                alert("Busque e selecione um material na lista.");
                return;
            }
            const quantidade = parseFloat(document.getElementById('input-metros').value);
            if (isNaN(quantidade) || quantidade <= 0) {
                alert("Insira a quantidade utilizada.");
                return;
            }

            let custoCalculado = 0;
            let labelUnidade = "";

            if (materialSelecionado.porUnidade) {
                custoCalculado = materialSelecionado.preco * quantidade;
                labelUnidade = quantidade > 1 ? "unid." : "unid.";
            } else {
                custoCalculado = (materialSelecionado.preco / 6) * quantidade;
                labelUnidade = "m";
            }

            materiaisAdicionados.push({
                nome: materialSelecionado.nome,
                quantidade: quantidade,
                labelUnidade: labelUnidade,
                custo: custoCalculado,
                tipo: 'material'
            });

            document.getElementById('input-busca').value = '';
            document.getElementById('input-metros').value = '';
            document.getElementById('label-quantidade').innerText = 'Metros / Qtd.';
            materialSelecionado = null;
            
            atualizarLista();
            calcularTotal();
        }

        function adicionarExtra() {
            const nome = document.getElementById('input-extra-nome').value.trim() || 'Insumo Extra';
            const custo = parseFloat(document.getElementById('input-extra-valor').value);

            if (isNaN(custo) || custo <= 0) {
                alert("Insira um valor para o insumo extra.");
                return;
            }

            materiaisAdicionados.push({
                nome: nome,
                quantidade: 1,
                labelUnidade: "item",
                custo: custo,
                tipo: 'extra'
            });

            document.getElementById('input-extra-nome').value = '';
            document.getElementById('input-extra-valor').value = '';
            
            atualizarLista();
            calcularTotal();
        }

        function removerMaterial(index) {
            materiaisAdicionados.splice(index, 1);
            atualizarLista();
            calcularTotal();
        }

        function atualizarLista() {
            const container = document.getElementById('lista-materiais');
            container.innerHTML = ''; 

            if (materiaisAdicionados.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-600 italic py-2">Nenhum item adicionado ainda.</p>';
                return;
            }

            materiaisAdicionados.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-zinc-900 rounded-md p-3 border border-white/5";
                const corIcone = item.tipo === 'extra' ? 'text-gray-400' : 'text-gold-400';
                div.innerHTML = `
                    <div class="pr-2">
                        <p class="text-[11px] md:text-sm text-white leading-tight">${item.nome}</p>
                        <p class="text-[10px] md:text-xs ${corIcone} mt-1">${item.quantidade} ${item.labelUnidade}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs md:text-sm font-semibold font-mono">${formatarMoeda(item.custo)}</span>
                        <button onclick="removerMaterial(${index})" class="text-red-500 hover:text-red-400 bg-red-500/10 p-2 rounded-md"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function calcularTotal() {
            const totalMateriais = materiaisAdicionados.reduce((acc, item) => acc + item.custo, 0);

            const qtdPintura = parseFloat(document.getElementById('qtd-pintura').value) || 0;
            const valorPintura = parseFloat(document.getElementById('valor-pintura').value) || 0;
            const totalPintura = qtdPintura * valorPintura;

            const custoBruto = totalMateriais + totalPintura;

            const percentualMargem = parseFloat(document.getElementById('margem-lucro').value) || 0;
            const valorMargem = custoBruto * (percentualMargem / 100);

            const custoComMargem = custoBruto + valorMargem;

            const multiplicador = parseFloat(document.getElementById('multiplicador').value) || 1;
            
            const precoFinal = (custoBruto * multiplicador) + valorMargem;
            const lucroMaoDeObra = precoFinal - custoComMargem;

            document.getElementById('txt-porcentagem-margem').innerText = percentualMargem;
            document.getElementById('resumo-custo').innerText = formatarMoeda(custoBruto);
            document.getElementById('preco-final').innerText = formatarMoeda(precoFinal);

            document.getElementById('detalhe-materiais').innerText = formatarMoeda(totalMateriais);
            document.getElementById('detalhe-pintura').innerText = formatarMoeda(totalPintura);
            document.getElementById('detalhe-custo-bruto').innerText = formatarMoeda(custoBruto);
            document.getElementById('detalhe-margem').innerText = formatarMoeda(valorMargem);
            document.getElementById('detalhe-lucro').innerText = formatarMoeda(lucroMaoDeObra);
            document.getElementById('detalhe-total').innerText = formatarMoeda(precoFinal);
        }

        // ===============================================
        // MÁGICA DO PDF CORRIGIDA
        // ===============================================
        async function compartilharPDF() {
            if (materiaisAdicionados.length === 0) {
                alert("Adicione materiais antes de gerar o orçamento.");
                return;
            }

            // 1. Força a tela a rolar para o topo absoluto (CORRIGE O BUG DO CORTE)
            window.scrollTo({ top: 0, behavior: 'auto' });

            // 2. Aciona a tela de Loading para o usuário não clicar duas vezes
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('hidden');
            loading.classList.add('flex');

            // 3. Preenche os dados no PDF
            document.getElementById('print-data').innerText = `Data: ${new Date().toLocaleDateString('pt-BR')}`;
            
            const listaPrint = document.getElementById('print-lista-materiais');
            listaPrint.innerHTML = '';
            materiaisAdicionados.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${item.nome}</strong> - (${item.quantidade} ${item.labelUnidade})`;
                listaPrint.appendChild(li);
            });

            const servicosPrint = document.getElementById('print-lista-servicos');
            servicosPrint.innerHTML = `
                <li>Corte, esquadrejamento e montagem estrutural sob medida.</li>
                <li>Soldagem premium e polimento de junções para acabamento impecável.</li>
            `;
            const qtdPintura = parseFloat(document.getElementById('qtd-pintura').value) || 0;
            if (qtdPintura > 0) {
                servicosPrint.innerHTML += `<li>Acabamento Especial: Pintura Epóxi.</li>`;
            }

            document.getElementById('print-total').innerText = document.getElementById('preco-final').innerText;

            // 4. Mostra o PDF e esconde a calculadora para a foto perfeita
            const app = document.getElementById('app-calculadora');
            const printSec = document.getElementById('print-section');
            
            app.style.display = 'none'; 
            printSec.classList.remove('hidden');
            printSec.classList.add('block'); 

            // Dá um tempinho pequeno pro celular processar o layout
            setTimeout(async () => {
                try {
                    const opt = {
                        margin:       [15, 0, 15, 0], // Margens: Cima, Direita, Baixo, Esquerda
                        filename:     'Orcamento_AcoFino.pdf',
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { 
                            scale: 2, 
                            useCORS: true, 
                            allowTaint: true,
                            windowWidth: 800,
                            scrollY: 0 // <--- Garante que a foto comece do ponto 0
                        },
                        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } // <--- Evita cortar texto no meio
                    };

                    const pdfBlob = await html2pdf().set(opt).from(printSec).output('blob');
                    const file = new File([pdfBlob], "Orcamento_AcoFino.pdf", { type: "application/pdf" });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'Orçamento Aço Fino',
                            text: 'Segue em anexo o orçamento detalhado.',
                            files: [file]
                        });
                    } else {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(pdfBlob);
                        link.download = 'Orcamento_AcoFino.pdf';
                        link.click();
                    }
                } catch (error) {
                    console.error("Erro ao gerar PDF: ", error);
                    alert("Erro ao gerar o PDF. Verifique sua conexão e tente novamente.");
                } finally {
                    // Volta tudo ao normal
                    printSec.classList.remove('block');
                    printSec.classList.add('hidden');
                    app.style.display = 'flex';
                    
                    loading.classList.remove('flex');
                    loading.classList.add('hidden');
                }
            }, 600); 
        }

        function limparTudo() {
            if(confirm("Tem certeza que deseja limpar todo o orçamento?")) {
                materiaisAdicionados = [];
                document.getElementById('input-busca').value = '';
                document.getElementById('input-metros').value = '';
                document.getElementById('input-extra-nome').value = '';
                document.getElementById('input-extra-valor').value = '';
                document.getElementById('qtd-pintura').value = '0';
                document.getElementById('multiplicador').value = '2.5'; 
                document.getElementById('margem-lucro').value = '15'; 
                document.getElementById('label-quantidade').innerText = 'Metros / Qtd.';
                materialSelecionado = null;
                atualizarLista();
                calcularTotal();
            }
        }
    </script>
</body>
</html>